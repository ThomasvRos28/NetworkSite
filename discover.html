<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover - ConnectPro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Discover Page Specific Styles */
        .discover-section {
            padding: 30px 0;
            min-height: calc(100vh - 70px);
        }

        .discover-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .discover-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .discover-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .discover-header p {
            color: var(--text-light);
        }

        .card-container {
            position: relative;
            height: 450px;
            margin-bottom: 20px;
        }

        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
            cursor: grab;
            display: flex;
            flex-direction: column;
        }

        .card-image {
            height: 60%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-image .profile-initials {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
        }

        .card-image .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-position {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .card-details {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 10px;
            flex-grow: 1;
        }

        .card-location {
            font-size: 0.9rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
        }

        .card-location i {
            margin-right: 5px;
        }

        .card-distance {
            font-size: 0.9rem;
            color: #4CAF50;
            margin-top: 5px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .card-distance i {
            margin-right: 5px;
            font-size: 0.8rem;
        }

        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .swipe-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dislike-button {
            background-color: white;
            color: #ff5c5c;
            border: 1px solid #ff5c5c;
        }

        .dislike-button:hover {
            background-color: #ff5c5c;
            color: white;
        }

        .like-button {
            background-color: white;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .like-button:hover {
            background-color: #4CAF50;
            color: white;
        }

        .card.swiped-left {
            transform: translateX(-150%) rotate(-30deg);
            opacity: 0;
        }

        .card.swiped-right {
            transform: translateX(150%) rotate(30deg);
            opacity: 0;
        }

        .card.has-liked-you {
            position: relative;
        }

        .card.has-liked-you::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10;
            border-radius: 10px;
            pointer-events: none;
        }

        .card.has-liked-you::after {
            content: "Someone likes you!";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3797F0;
            font-weight: bold;
            font-size: 1.5rem;
            z-index: 11;
            text-align: center;
            width: 80%;
            pointer-events: none;
        }

        .no-more-cards {
            text-align: center;
            padding: 40px 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .no-more-cards h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .no-more-cards p {
            color: var(--text-light);
            margin-bottom: 20px;
        }

        .match-notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .match-notification.active {
            opacity: 1;
            pointer-events: auto;
        }

        .match-content {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .match-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .match-message {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .match-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* Special styling for matches from blurred profiles */
        .match-notification.special-match .match-content {
            background: linear-gradient(135deg, #3797F0, #45B8AC);
            color: white;
        }

        .match-notification.special-match .match-title {
            color: white;
        }

        .match-notification.special-match .match-message {
            color: rgba(255, 255, 255, 0.9);
        }

        .match-notification.special-match .btn-outline {
            color: white;
            border-color: white;
        }

        .match-notification.special-match .btn-outline:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Location status styles */
        .location-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 10px auto;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            max-width: fit-content;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #2ecc71; /* Green for enabled */
        }

        .status-indicator.disabled {
            background-color: #e74c3c; /* Red for disabled */
        }

        .status-text {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .btn-small {
            font-size: 0.8rem;
            padding: 4px 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-small:hover {
            background-color: var(--primary-color-dark);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>ConnectPro</h1>
            </div>
            <nav>
                <ul class="nav-links" id="logged-in-nav" style="display: none;">
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="network.html">Network</a></li>
                    <li><a href="discover.html" class="active">Discover</a></li>
                    <li><a href="swipe-history.html">History</a></li>
                    <li><a href="mentorship.html">Mentorship</a></li>
                    <li><a href="messages.html" class="messages-link" style="display: none;">Messages</a></li>
                    <li><a href="#">Notifications</a></li>
                </ul>
                <ul class="nav-links" id="logged-out-nav">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="login.html">Sign In</a></li>
                    <li><a href="signup.html">Sign Up</a></li>
                </ul>
                <div class="nav-icons">
                    <div class="user-dropdown" id="user-dropdown" style="display: none;">
                        <div class="user-avatar" id="user-avatar"></div>
                        <div class="dropdown-content">
                            <a href="dashboard.html">Dashboard</a>
                            <a href="#" id="logout-link">Logout</a>
                        </div>
                    </div>
                </div>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Discover Section -->
    <section class="discover-section">
        <div class="container">
            <div class="discover-container">
                <div class="discover-header">
                    <h1>Discover</h1>
                    <p>Swipe right on professionals you'd like to connect with</p>
                    <div class="location-status" id="location-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Location sharing is enabled</span>
                        <button id="update-location-btn" class="btn btn-small">
                            <i class="fas fa-location-arrow"></i> Update
                        </button>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                        <a href="swipe-history.html" class="btn btn-outline" style="font-size: 0.9rem; padding: 8px 15px;">
                            <i class="fas fa-history"></i> View Swipe History
                        </a>
                        <button id="reset-swipes-btn" class="btn btn-outline" style="font-size: 0.9rem; padding: 8px 15px; background-color: #ff9800; color: white; border: none;">
                            <i class="fas fa-trash"></i> Reset My Swipes
                        </button>
                    </div>
                </div>
                <div class="card-container" id="card-container">
                    <!-- Cards will be dynamically added here -->
                    <div class="loading-cards">Loading potential connections...</div>
                </div>
                <div class="swipe-buttons">
                    <div class="swipe-button dislike-button" id="dislike-button">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="swipe-button like-button" id="like-button">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Match Notification -->
    <div class="match-notification" id="match-notification">
        <div class="match-content">
            <h2 class="match-title">It's a Match!</h2>
            <p class="match-message">You and <span id="match-name">John</span> have liked each other.</p>
            <div class="match-buttons">
                <button class="btn btn-primary" id="send-message-btn">Send Message</button>
                <button class="btn btn-outline" id="keep-swiping-btn">Keep Swiping</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userData = localStorage.getItem('user');
            if (!userData) {
                window.location.href = 'signin.html';
                return;
            }

            // Parse user data
            const user = JSON.parse(userData);

            // Update UI based on login status
            const loggedOutNav = document.getElementById('logged-out-nav');
            const loggedInNav = document.getElementById('logged-in-nav');
            const userDropdown = document.getElementById('user-dropdown');
            const userAvatar = document.getElementById('user-avatar');
            const messagesLink = document.querySelector('.messages-link');

            loggedOutNav.style.display = 'none';
            loggedInNav.style.display = 'flex';
            userDropdown.style.display = 'block';
            messagesLink.style.display = 'block';

            // Set user avatar
            userAvatar.innerHTML = getInitials(user.firstName, user.lastName, user.username);

            // Variables to track current card and potential matches
            let currentCardIndex = 0;
            let potentialMatches = [];

            // Initialize location status
            initLocationStatus();

            // Load potential matches
            loadPotentialMatches();

            // Add event listeners to swipe buttons
            document.getElementById('like-button').addEventListener('click', () => {
                handleSwipe('like');
            });

            document.getElementById('dislike-button').addEventListener('click', () => {
                handleSwipe('dislike');
            });

            // Match notification event listeners
            document.getElementById('keep-swiping-btn').addEventListener('click', () => {
                document.getElementById('match-notification').classList.remove('active');
            });

            document.getElementById('send-message-btn').addEventListener('click', () => {
                const matchId = document.getElementById('send-message-btn').getAttribute('data-match-id');
                window.location.href = `messages.html?conversation=${matchId}`;
            });

            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('user');
                window.location.href = 'signin.html';
            });

            // Reset swipes functionality
            document.getElementById('reset-swipes-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset your swipe history? This cannot be undone.')) {
                    resetMySwipes();
                }
            });

            // Function to load potential matches
            function loadPotentialMatches() {
                const cardContainer = document.getElementById('card-container');
                cardContainer.innerHTML = '<div class="loading-cards">Loading potential connections...</div>';

                fetch(`/api/potential-matches/${user.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            potentialMatches = data.potentialMatches;

                            if (potentialMatches.length === 0) {
                                showNoMoreCards();
                                return;
                            }

                            // Clear the container
                            cardContainer.innerHTML = '';

                            // Load profile pictures for all users
                            loadProfilePictures(potentialMatches);

                            // Create cards for each potential match
                            potentialMatches.forEach((match, index) => {
                                const card = createCard(match, index);
                                cardContainer.appendChild(card);
                            });

                            // Initialize touch events for cards
                            initializeCardSwipe();
                        } else {
                            cardContainer.innerHTML = `<div class="no-more-cards">
                                <h3>Error</h3>
                                <p>${data.message || 'Failed to load potential connections'}</p>
                            </div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading potential matches:', error);
                        cardContainer.innerHTML = `<div class="no-more-cards">
                            <h3>Error</h3>
                            <p>Failed to connect to server</p>
                        </div>`;
                    });
            }

            // Function to create a card for a potential match
            function createCard(match, index) {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.zIndex = 1000 - index;
                card.setAttribute('data-index', index);
                card.setAttribute('data-id', match._id);

                // Add 'has-liked-you' class if this user has already liked the current user
                if (match.hasLikedYou) {
                    card.classList.add('has-liked-you');
                }

                const fullName = `${match.firstName} ${match.lastName}`.trim() || match.username;
                const initials = getInitials(match.firstName, match.lastName, match.username);

                let position = '';
                let company = '';
                let location = '';
                let details = '';

                if (match.professionalInfo) {
                    position = match.professionalInfo.fieldOfWork || '';
                    company = match.professionalInfo.companyName ? ` at ${match.professionalInfo.companyName}` : '';

                    const country = match.professionalInfo.country || '';
                    const city = match.professionalInfo.location || '';
                    location = [city, country].filter(Boolean).join(', ');

                    details = match.professionalInfo.mentorshipDetails || '';
                }

                // Try to get the user's profile picture from localStorage
                const profilePicKey = `profilePicture_${match._id}`;
                const profilePic = localStorage.getItem(profilePicKey);

                card.innerHTML = `
                    <div class="card-image">
                        ${profilePic ?
                            `<img src="${profilePic}" alt="${fullName}" class="profile-pic">` :
                            `<div class="profile-initials">${initials}</div>`
                        }
                    </div>
                    <div class="card-content">
                        <div class="card-name">${fullName}</div>
                        <div class="card-position">${position}${company}</div>
                        <div class="card-details">${details}</div>
                        ${location ? `<div class="card-location"><i class="fas fa-map-marker-alt"></i> ${location}</div>` : ''}
                        ${match.distance ? `<div class="card-distance"><i class="fas fa-location-arrow"></i> ${match.distance} km away</div>` : ''}
                    </div>
                `;

                return card;
            }

            // Function to initialize touch/swipe events
            function initializeCardSwipe() {
                const cards = document.querySelectorAll('.card');

                cards.forEach(card => {
                    let startX = 0;
                    let currentX = 0;

                    // Touch events for mobile
                    card.addEventListener('touchstart', e => {
                        startX = e.touches[0].clientX;
                    });

                    card.addEventListener('touchmove', e => {
                        currentX = e.touches[0].clientX;
                        const diffX = currentX - startX;

                        // Calculate rotation based on swipe distance
                        const rotate = diffX / 10;

                        // Apply transform to the card
                        card.style.transform = `translateX(${diffX}px) rotate(${rotate}deg)`;

                        // Change opacity of background color based on swipe direction
                        if (diffX > 0) {
                            // Swiping right - green background
                            card.style.backgroundColor = `rgba(76, 175, 80, ${Math.min(diffX / 100, 0.3)})`;
                        } else if (diffX < 0) {
                            // Swiping left - red background
                            card.style.backgroundColor = `rgba(255, 92, 92, ${Math.min(Math.abs(diffX) / 100, 0.3)})`;
                        }
                    });

                    card.addEventListener('touchend', e => {
                        const diffX = currentX - startX;

                        // If swiped far enough, trigger the appropriate action
                        if (diffX > 100) {
                            // Swiped right - like
                            card.classList.add('swiped-right');
                            setTimeout(() => {
                                handleSwipe('like');
                            }, 300);
                        } else if (diffX < -100) {
                            // Swiped left - dislike
                            card.classList.add('swiped-left');
                            setTimeout(() => {
                                handleSwipe('dislike');
                            }, 300);
                        } else {
                            // Reset card position if not swiped far enough
                            card.style.transform = '';
                            card.style.backgroundColor = '';
                        }
                    });

                    // Mouse events for desktop
                    card.addEventListener('mousedown', e => {
                        startX = e.clientX;
                        card.style.cursor = 'grabbing';

                        // Add mousemove and mouseup event listeners
                        document.addEventListener('mousemove', moveHandler);
                        document.addEventListener('mouseup', upHandler);
                    });

                    function moveHandler(e) {
                        currentX = e.clientX;
                        const diffX = currentX - startX;

                        // Calculate rotation based on swipe distance
                        const rotate = diffX / 10;

                        // Apply transform to the card
                        card.style.transform = `translateX(${diffX}px) rotate(${rotate}deg)`;

                        // Change opacity of background color based on swipe direction
                        if (diffX > 0) {
                            // Swiping right - green background
                            card.style.backgroundColor = `rgba(76, 175, 80, ${Math.min(diffX / 100, 0.3)})`;
                        } else if (diffX < 0) {
                            // Swiping left - red background
                            card.style.backgroundColor = `rgba(255, 92, 92, ${Math.min(Math.abs(diffX) / 100, 0.3)})`;
                        }
                    }

                    function upHandler(e) {
                        card.style.cursor = 'grab';
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('mouseup', upHandler);

                        const diffX = currentX - startX;

                        // If swiped far enough, trigger the appropriate action
                        if (diffX > 100) {
                            // Swiped right - like
                            card.classList.add('swiped-right');
                            setTimeout(() => {
                                handleSwipe('like');
                            }, 300);
                        } else if (diffX < -100) {
                            // Swiped left - dislike
                            card.classList.add('swiped-left');
                            setTimeout(() => {
                                handleSwipe('dislike');
                            }, 300);
                        } else {
                            // Reset card position if not swiped far enough
                            card.style.transform = '';
                            card.style.backgroundColor = '';
                        }
                    }
                });
            }

            // Function to handle swipe action (like/dislike)
            function handleSwipe(action) {
                if (potentialMatches.length === 0) return;

                const currentCard = document.querySelector(`.card[data-index="${currentCardIndex}"]`);
                if (!currentCard) return;

                const userId = user.id;
                const matchId = currentCard.getAttribute('data-id');
                const isBlurredProfile = currentCard.classList.contains('has-liked-you');

                // Send the swipe action to the server
                fetch('/api/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fromUserId: userId,
                        toUserId: matchId,
                        action: action
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If it's a mutual match, show the match notification
                        if (data.mutualMatch) {
                            // Get the matched user data
                            const matchedUserData = {
                                _id: data.matchedUser.id,
                                firstName: data.matchedUser.name.split(' ')[0] || '',
                                lastName: data.matchedUser.name.split(' ')[1] || '',
                                username: data.matchedUser.name
                            };

                            // If this was a blurred profile (someone who already liked you),
                            // show a special message
                            if (isBlurredProfile && action === 'like') {
                                showMatchNotification(matchedUserData, true);
                            } else {
                                showMatchNotification(matchedUserData, false);
                            }

                            // Show browser notification
                            if (Notification.permission === 'granted') {
                                new Notification('New Match!', {
                                    body: `You and ${data.matchedUser.name} have liked each other.`,
                                    icon: '/favicon.ico'
                                });
                            }
                        }

                        // Remove the current card from the DOM after animation completes
                        setTimeout(() => {
                            if (currentCard) {
                                currentCard.remove();
                            }

                            // Move to the next card
                            currentCardIndex++;

                            // If no more cards, show the "no more cards" message
                            if (currentCardIndex >= potentialMatches.length) {
                                showNoMoreCards();
                            }
                        }, 300);
                    } else {
                        console.error('Error recording match action:', data.message);
                        // Reset the card if there was an error
                        currentCard.style.transform = '';
                        currentCard.style.backgroundColor = '';
                        currentCard.classList.remove('swiped-left', 'swiped-right');
                    }
                })
                .catch(error => {
                    console.error('Error sending match action:', error);
                    // Reset the card if there was an error
                    currentCard.style.transform = '';
                    currentCard.style.backgroundColor = '';
                    currentCard.classList.remove('swiped-left', 'swiped-right');
                });
            }

            // Function to show the match notification
            function showMatchNotification(match, wasBlurred = false) {
                const fullName = `${match.firstName} ${match.lastName}`.trim() || match.username;
                document.getElementById('match-name').textContent = fullName;
                document.getElementById('send-message-btn').setAttribute('data-match-id', match._id);

                // Update the message based on whether this was a blurred profile
                const matchMessage = document.querySelector('.match-message');
                if (wasBlurred) {
                    matchMessage.innerHTML = `
                        <div style="margin-bottom: 10px;">You've unlocked a match with <span id="match-name">${fullName}</span>! They already liked your profile.</div>
                        <div style="font-weight: bold; color: #4CAF50; margin-bottom: 10px;">You are now connected!</div>
                        <div style="font-size: 0.9rem;">You can now message each other and collaborate.</div>
                    `;

                    // Add a special class to the notification for styling
                    document.getElementById('match-notification').classList.add('special-match');
                } else {
                    matchMessage.innerHTML = `
                        <div style="margin-bottom: 10px;">You and <span id="match-name">${fullName}</span> have liked each other.</div>
                        <div style="font-weight: bold; color: #4CAF50; margin-bottom: 10px;">You are now connected!</div>
                        <div style="font-size: 0.9rem;">You can now message each other and collaborate.</div>
                    `;
                    document.getElementById('match-notification').classList.remove('special-match');
                }

                document.getElementById('match-notification').classList.add('active');
            }

            // Function to show the "no more cards" message
            function showNoMoreCards() {
                const cardContainer = document.getElementById('card-container');
                cardContainer.innerHTML = `
                    <div class="no-more-cards">
                        <h3>No More Profiles</h3>
                        <p>You've seen all potential connections for now. Check back later for more!</p>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="window.location.reload()">Refresh</button>
                            <a href="swipe-history.html" class="btn btn-outline">View Swipe History</a>
                        </div>
                        <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-light);">
                            Want to change your mind about someone? Visit your <a href="swipe-history.html">Swipe History</a> to update your previous decisions.
                        </p>
                        <p style="margin-top: 15px;">
                            <button onclick="resetMySwipes()" class="btn" style="background-color: #ff9800; color: white;">Reset My Swipes</button>
                        </p>
                    </div>
                `;

                // Hide the swipe buttons
                document.querySelector('.swipe-buttons').style.display = 'none';
            }

            // Function to reset my swipes
            function resetMySwipes() {
                fetch(`/api/reset-swipes/${user.id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Your swipe history has been reset successfully. The page will now reload.');
                        window.location.reload();
                    } else {
                        alert('Error resetting swipe history: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error resetting swipe history:', error);
                    alert('Error connecting to server. Please try again later.');
                });
            }

            // Function to initialize location status
            function initLocationStatus() {
                const locationStatus = document.getElementById('location-status');
                const statusIndicator = locationStatus.querySelector('.status-indicator');
                const statusText = locationStatus.querySelector('.status-text');
                const updateLocationBtn = document.getElementById('update-location-btn');

                // Check if location sharing is enabled
                fetch(`/api/user/${user.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const userData = data.user;

                            if (userData.professionalInfo && userData.professionalInfo.locationSharingEnabled) {
                                statusIndicator.classList.remove('disabled');
                                statusText.textContent = 'Location sharing is enabled';
                            } else {
                                statusIndicator.classList.add('disabled');
                                statusText.textContent = 'Location sharing is disabled';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user data:', error);
                    });

                // Handle update location button click
                updateLocationBtn.addEventListener('click', function() {
                    if (navigator.geolocation) {
                        updateLocationBtn.disabled = true;
                        updateLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                        navigator.geolocation.getCurrentPosition(
                            // Success callback
                            function(position) {
                                updateUserLocation(user.id, position.coords.latitude, position.coords.longitude, true)
                                    .then(() => {
                                        // Update status indicator
                                        statusIndicator.classList.remove('disabled');
                                        statusText.textContent = 'Location sharing is enabled';

                                        // Reload potential matches
                                        loadPotentialMatches();

                                        // Reset button
                                        updateLocationBtn.disabled = false;
                                        updateLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Update';

                                        // Show notification
                                        alert('Your location has been updated successfully. Matches will now be sorted by distance.');
                                    })
                                    .catch(error => {
                                        console.error('Error updating location:', error);
                                        updateLocationBtn.disabled = false;
                                        updateLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Update';
                                        alert('Error updating location. Please try again.');
                                    });
                            },
                            // Error callback
                            function(error) {
                                console.warn('Error getting location:', error.message);
                                updateLocationBtn.disabled = false;
                                updateLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Update';

                                let errorMessage = 'Error getting your location. ';
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMessage += 'Please enable location access in your browser settings.';
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMessage += 'Location information is unavailable.';
                                        break;
                                    case error.TIMEOUT:
                                        errorMessage += 'The request to get your location timed out.';
                                        break;
                                    default:
                                        errorMessage += 'An unknown error occurred.';
                                }

                                alert(errorMessage);
                            },
                            // Options
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        alert('Geolocation is not supported by your browser');
                    }
                });

                // Try to get location automatically on page load
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            updateUserLocation(user.id, position.coords.latitude, position.coords.longitude, true)
                                .then(() => {
                                    // Update status indicator
                                    statusIndicator.classList.remove('disabled');
                                    statusText.textContent = 'Location sharing is enabled';
                                })
                                .catch(error => {
                                    console.error('Error updating location:', error);
                                });
                        },
                        function(error) {
                            console.warn('Error getting location on page load:', error.message);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            }

            // Function to update user location
            function updateUserLocation(userId, latitude, longitude, locationSharingEnabled) {
                return fetch(`/api/update-location/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude,
                        longitude,
                        locationSharingEnabled
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message || 'Error updating location');
                    }
                    return data;
                });
            }

            // Function to load profile pictures for all users
            function loadProfilePictures(users) {
                // In a real app, you would fetch each user's profile picture from the server
                // For this demo, we'll just check if we already have them in localStorage

                // We won't copy the current user's profile picture to other users anymore
                // Each user will have their own profile picture or none at all

                // This function is now a placeholder for where you would fetch profile pictures
                // from the server in a real application
            }
        });

        // Helper function to get initials from name
        function getInitials(firstName, lastName, username) {
            if (firstName && lastName) {
                return `${firstName.charAt(0)}${lastName.charAt(0)}`;
            } else if (firstName) {
                return firstName.charAt(0);
            } else if (username) {
                return username.charAt(0);
            } else {
                return 'U';
            }
        }
    </script>
</body>
</html>
