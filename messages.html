<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - ConnectPro</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Additional styles for the messages page */
        :root {
            --chat-bg-color: #f5f7fb;
            --sent-message-bg: #0a66c2;
            --received-message-bg: #ffffff;
            --system-message-bg: rgba(0, 0, 0, 0.05);
            --message-border-radius: 18px;
            --message-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            --typing-dot-color: var(--primary-color);
        }

        .messages-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 10px;
            width: 90%;
        }

        .messages-header {
            margin-bottom: 15px;
        }

        .messages-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .messages-header p {
            font-size: 1rem;
            color: var(--text-light);
        }

        .messages-layout {
            display: grid;
            grid-template-columns: 180px 1fr; /* Further reduce sidebar width */
            grid-template-rows: 1fr auto; /* Add row template for chat area and input */
            grid-template-areas:
                "sidebar main"
                "sidebar input";
            gap: 0; /* Remove gap to maximize space */
            height: 70vh; /* Reduced height to fit better on page */
            min-height: 550px; /* Reduced minimum height */
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .conversations-list {
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            height: 100%;
            grid-area: sidebar;
            font-size: 0.9rem; /* Smaller font size */
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .conversation-item:hover, .conversation-item.active {
            background-color: rgba(10, 102, 194, 0.05);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--primary-color);
            margin-right: 10px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .conversation-avatar .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .conversation-info {
            flex-grow: 1;
            overflow: hidden;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }

        .conversation-name {
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
            font-size: 0.9rem;
        }

        .conversation-time {
            font-size: 0.7rem;
            color: var(--text-light);
        }

        .conversation-preview {
            color: var(--text-light);
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .unread-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin-left: 10px;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%; /* Ensure it takes full width */
            background-color: var(--chat-bg-color);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23bbc5d7' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            box-sizing: border-box; /* Include padding in width calculation */
            grid-area: main;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #DBDBDB; /* Instagram border color */
            background-color: white;
            z-index: 10;
            box-sizing: border-box;
            position: relative;
            height: auto;
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.05), transparent);
            pointer-events: none;
        }

        .chat-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
        }

        .chat-avatar-container {
            position: relative;
            margin-right: 10px;
        }

        .chat-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #FAFAFA; /* Instagram background */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #262626; /* Instagram text color */
            border: 1px solid #DBDBDB; /* Instagram border */
            overflow: hidden;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            max-width: 100%;
            max-height: 100%;
        }

        .edit-avatar-btn {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #3797F0; /* Instagram blue */
            color: white;
            border: 1px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.4rem;
            cursor: pointer;
            padding: 0;
            transition: all 0.2s ease;
        }

        .edit-avatar-btn:hover {
            background-color: #0064E0;
            transform: scale(1.1);
        }

        .chat-user-name {
            font-weight: 600;
            margin: 0;
            font-size: 0.75rem;
            color: #262626; /* Instagram text color */
        }

        .chat-user-status {
            font-size: 0.6rem;
            color: #8E8E8E; /* Instagram secondary text color */
            display: flex;
            align-items: center;
            margin-top: 1px;
        }

        .chat-user-status::before {
            content: '';
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #4CAF50;
            margin-right: 3px;
        }

        .chat-user-status.offline::before {
            background-color: #9e9e9e;
        }

        .chat-actions {
            display: flex;
            gap: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 4px;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .action-button-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #F0F2F5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3px;
            color: #262626;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .action-button-icon:hover {
            background-color: #E4E6EB;
            transform: translateY(-2px);
        }

        .action-button-label {
            font-size: 0.6rem;
            color: #8E8E8E;
            font-weight: 500;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: #262626; /* Instagram icon color */
            font-size: 1rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-action-btn:hover {
            color: #3797F0; /* Instagram blue */
        }

        /* Instagram-like header info container */
        .chat-header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            margin-bottom: 4px;
        }

        .user-info-pill {
            display: inline-flex;
            align-items: center;
            background-color: #FAFAFA;
            border-radius: 16px;
            padding: 2px 8px 2px 2px;
            border: 1px solid #DBDBDB;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .messages-list {
            flex-grow: 1;
            padding: 12px 16px; /* Reduced padding */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            width: 100%; /* Ensure it takes full width */
            box-sizing: border-box; /* Include padding in width calculation */
            height: calc(100% - 100px); /* Account for smaller header with action buttons */
            background-color: white; /* Instagram uses white background */
        }

        /* Group messages by sender with less spacing between them */
        .message + .message.sent {
            margin-top: 2px;
        }

        .message + .message.received {
            margin-top: 2px;
        }

        /* Add more space between different senders */
        .message.sent + .message.received,
        .message.received + .message.sent {
            margin-top: 16px;
        }

        .message {
            max-width: 65%; /* Slightly narrower */
            padding: 8px 12px;
            border-radius: 18px; /* More rounded like Instagram */
            margin-bottom: 6px; /* Closer together */
            position: relative;
            box-shadow: var(--message-shadow);
            animation: fadeIn 0.3s ease;
            line-height: 1.35;
            word-wrap: break-word; /* Ensure long words don't overflow */
            overflow-wrap: break-word;
            font-size: 0.9rem; /* Smaller font size */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap; /* Preserve line breaks but wrap text */
            max-width: 100%; /* Ensure content doesn't overflow */
            box-sizing: border-box;
            line-height: 1.5; /* Improved line height for readability */
            letter-spacing: 0.01em; /* Slight letter spacing for readability */
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
        }

        .message-status {
            font-size: 0.7rem;
            color: inherit;
            opacity: 0.7;
        }

        .message.sent {
            align-self: flex-end;
            background-color: #3797F0; /* Instagram blue */
            color: white;
            border-bottom-right-radius: 5px;
            margin-left: 10%; /* Instagram-like spacing */
            box-sizing: border-box; /* Include border in width calculation */
        }

        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.65rem; /* Smaller time */
        }

        .message.received {
            align-self: flex-start;
            background-color: #EFEFEF; /* Instagram gray */
            color: #262626; /* Instagram text color */
            border-bottom-left-radius: 5px;
            margin-right: 10%; /* Instagram-like spacing */
            box-sizing: border-box; /* Include border in width calculation */
        }

        .message.received .message-time {
            font-size: 0.65rem; /* Smaller time */
        }

        .message.system {
            align-self: center;
            background-color: var(--system-message-bg);
            color: var(--text-light);
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px 16px;
            max-width: 85%;
            box-shadow: none;
            border-radius: 12px;
            margin: 15px 0;
        }

        .message.system .message-time {
            text-align: center;
            justify-content: center;
        }

        /* Date separator - Instagram style */
        .date-separator {
            align-self: center;
            margin: 24px 0 16px;
            display: flex;
            align-items: center;
            width: 100%;
        }

        .date-separator-text {
            padding: 4px 12px;
            font-size: 0.75rem;
            color: #8E8E8E; /* Instagram text color */
            background-color: #EFEFEF; /* Instagram gray */
            border-radius: 16px;
            font-weight: 500;
        }

        .message-input {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-top: 1px solid #DBDBDB; /* Instagram border color */
            background-color: white;
            position: relative;
            grid-area: input;
            width: 100%;
            box-sizing: border-box;
            height: 50px; /* Fixed height */
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            flex-grow: 1;
            background-color: #EFEFEF; /* Instagram input background */
            border-radius: 22px;
            padding: 0 5px 0 15px;
            border: none;
            transition: all 0.3s ease;
        }

        .message-input-wrapper:focus-within {
            background-color: #E8E8E8;
        }

        .message-input input {
            flex-grow: 1;
            padding: 8px 6px;
            border: none;
            background: transparent;
            font-size: 0.85rem;
            outline: none;
            color: #262626; /* Instagram text color */
            height: 32px; /* Fixed height */
        }

        .message-input input::placeholder {
            color: #8E8E8E; /* Instagram placeholder color */
        }

        .emoji-btn {
            background: none;
            border: none;
            color: #8E8E8E; /* Instagram icon color */
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-btn:hover {
            color: #3797F0; /* Instagram blue */
        }

        .message-input button {
            background: none;
            color: #3797F0; /* Instagram blue */
            border: none;
            width: 36px;
            height: 36px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .message-input button:hover {
            color: #0064E0; /* Darker blue on hover */
        }

        .message-input button:disabled {
            color: #C7E0F4; /* Light blue when disabled */
            cursor: default;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-light);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 5px;
            align-items: center;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            margin-left: 5px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--typing-dot-color);
            margin: 0 1px;
            opacity: 0.6;
        }

        .typing-dot:nth-child(1) {
            animation: typingDot 1.4s infinite;
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation: typingDot 1.4s infinite;
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation: typingDot 1.4s infinite;
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(-5px); opacity: 1; }
            100% { transform: translateY(0); opacity: 0.6; }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
        }

        .empty-state i {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.6;
            background-color: rgba(10, 102, 194, 0.1);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .empty-state h3 {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .empty-state p {
            color: var(--text-light);
            margin-bottom: 20px;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
            font-size: 1.1rem;
        }

        /* Video chat modal */
        .video-chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .video-chat-container {
            width: 90%;
            max-width: 1000px;
            background-color: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .video-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
        }

        .video-chat-title {
            margin: 0;
            font-size: 1.2rem;
        }

        .video-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .video-streams {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 20px;
            height: 60vh;
        }

        .video-stream {
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .video-stream video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-stream.local {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            z-index: 10;
            border: 2px solid white;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background-color: #f1f1f1;
        }

        .video-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .video-control-btn.mute {
            background-color: #4CAF50;
            color: white;
        }

        .video-control-btn.mute.active {
            background-color: #f44336;
        }

        .video-control-btn.video {
            background-color: #2196F3;
            color: white;
        }

        .video-control-btn.video.active {
            background-color: #f44336;
        }

        .video-control-btn.end-call {
            background-color: #f44336;
            color: white;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #DBDBDB;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #262626;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #8E8E8E;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #DBDBDB;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Profile picture upload styles */
        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .preview-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F0F2F5;
            border: 1px solid #DBDBDB;
        }

        .profile-pic-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #8E8E8E;
        }

        .upload-actions {
            display: flex;
            gap: 10px;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            max-width: 350px;
        }

        .notification::before {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .notification.success {
            background-color: #4CAF50;
            border-left: 5px solid #2E7D32;
        }

        .notification.success::before {
            content: '\f00c';
        }

        .notification.error {
            background-color: #F44336;
            border-left: 5px solid #C62828;
        }

        .notification.error::before {
            content: '\f00d';
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .messages-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                grid-template-areas:
                    "sidebar"
                    "main"
                    "input";
                height: auto;
            }

            .conversations-list {
                height: 180px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .chat-area {
                height: 400px;
            }

            .message-input {
                width: 100%;
            }

            .video-streams {
                grid-template-columns: 1fr;
            }
        }

        /* Smaller screens */
        @media (max-height: 700px) {
            .messages-layout {
                height: 65vh;
                min-height: 450px;
            }

            .messages-header {
                margin-bottom: 10px;
            }

            .messages-header h1 {
                font-size: 1.5rem;
            }

            .action-buttons {
                gap: 10px;
            }

            .action-button-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .messages-list {
                height: calc(100% - 120px);
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="container">
            <div class="logo">
                <h1><a href="dashboard.html">ConnectPro</a></h1>
            </div>
            <nav>
                <ul class="nav-links">
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="network.html">Network</a></li>
                    <li><a href="discover.html">Discover</a></li>
                    <li><a href="swipe-history.html">History</a></li>
                    <li><a href="mentorship.html">Mentorship</a></li>
                    <li><a href="messages.html" class="active">Messaging</a></li>
                    <li><a href="#">Notifications</a></li>
                </ul>
                <div class="nav-icons">
                    <div class="notification-dropdown">
                        <div class="notification-bell">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                            <div class="notification-tooltip">
                                <div class="notification-tooltip-item">
                                    <div class="tooltip-avatar">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="tooltip-content">
                                        <strong>John Smith</strong> sent you a connection request
                                        <span class="tooltip-time">2h ago</span>
                                    </div>
                                </div>
                                <div class="notification-tooltip-item">
                                    <div class="tooltip-avatar">
                                        <i class="fas fa-comment"></i>
                                    </div>
                                    <div class="tooltip-content">
                                        <strong>Sarah Johnson</strong> sent you a message
                                        <span class="tooltip-time">5h ago</span>
                                    </div>
                                </div>
                                <div class="notification-tooltip-item">
                                    <div class="tooltip-avatar">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <div class="tooltip-content">
                                        <strong>Upcoming Meeting</strong> with Michael Brown
                                        <span class="tooltip-time">Tomorrow, 3:00 PM</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="notification-dropdown-content">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <a href="#" class="mark-all-read">Mark all as read</a>
                            </div>
                            <div class="notification-list">
                                <div class="notification-item unread">
                                    <div class="notification-avatar">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p><strong>John Smith</strong> sent you a connection request</p>
                                        <p class="notification-message">"I'd like to connect with you to discuss potential mentorship opportunities in software development."</p>
                                        <span class="notification-time">2 hours ago</span>
                                    </div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-avatar">
                                        <i class="fas fa-comment"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p><strong>Sarah Johnson</strong> sent you a message</p>
                                        <p class="notification-message">"Thanks for your advice on the project! I've implemented your suggestions and the client loved it."</p>
                                        <span class="notification-time">5 hours ago</span>
                                    </div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-avatar">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p><strong>Upcoming Meeting</strong> with Michael Brown</p>
                                        <p class="notification-message">"Your mentorship session is scheduled for tomorrow at 3:00 PM. Click to view details and join link."</p>
                                        <span class="notification-time">1 day ago</span>
                                    </div>
                                </div>
                                <div class="notification-item">
                                    <div class="notification-avatar">
                                        <i class="fas fa-share"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p><strong>Emily Davis</strong> shared your post</p>
                                        <p class="notification-message">"Great insights on modern web development frameworks! I've shared this with my team."</p>
                                        <span class="notification-time">2 days ago</span>
                                    </div>
                                </div>
                            </div>
                            <div class="notification-footer">
                                <a href="#">View all notifications</a>
                            </div>
                        </div>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-avatar" id="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-dropdown-content">
                            <a href="#"><i class="fas fa-user-circle"></i> View Profile</a>
                            <a href="#"><i class="fas fa-cog"></i> Settings</a>
                            <div class="divider"></div>
                            <a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Messages Content -->
    <section class="messages-section">
        <div class="messages-container">
            <div class="messages-header">
                <h1>Messages</h1>
                <p>Chat with your connections</p>
            </div>

            <div class="messages-layout">
                <!-- Conversations List -->
                <div class="conversations-list" id="conversations-list">
                    <!-- Conversations will be loaded here -->
                    <div class="loading">Loading conversations...</div>
                </div>

                <!-- Chat Area -->
                <div class="chat-area" id="chat-area">
                    <!-- Empty state when no conversation is selected -->
                    <div class="empty-state" id="empty-chat-state">
                        <i class="fas fa-comments"></i>
                        <h3>Select a Conversation</h3>
                        <p>Choose a conversation from the list or start a new one with your connections.</p>
                        <a href="network.html" class="btn btn-primary">Find Connections</a>
                    </div>

                    <!-- Chat interface (hidden by default) -->
                    <div id="chat-interface" style="display: none; height: 100%;">
                        <div class="chat-header">
                            <div class="chat-header-container">
                                <div class="user-info-pill">
                                    <div class="chat-avatar-container">
                                        <div class="chat-avatar" id="chat-user-avatar"></div>
                                        <button class="edit-avatar-btn" id="edit-profile-pic" title="Change profile picture">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    </div>
                                    <div>
                                        <h3 class="chat-user-name" id="chat-user-name"></h3>
                                        <p class="chat-user-status" id="chat-user-status">Online</p>
                                    </div>
                                </div>

                                <div class="action-buttons">
                                    <div class="action-button">
                                        <button class="action-button-icon" id="video-call-btn" title="Video call">
                                            <i class="fas fa-video"></i>
                                        </button>
                                        <span class="action-button-label">Video</span>
                                    </div>

                                    <div class="action-button">
                                        <button class="action-button-icon" title="Audio call">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <span class="action-button-label">Call</span>
                                    </div>

                                    <div class="action-button">
                                        <button class="action-button-icon" title="Profile">
                                            <i class="fas fa-user"></i>
                                        </button>
                                        <span class="action-button-label">Profile</span>
                                    </div>
                                </div>
                            </div>

                            <div class="chat-header-row">
                                <div class="chat-actions">
                                    <button class="chat-action-btn" title="Back">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                </div>
                                <div class="chat-actions">
                                    <button class="chat-action-btn" title="More options">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="messages-list" id="messages-list">
                            <!-- Messages will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Message Input Area (separate grid area) -->
                <div class="message-input" id="message-input-area" style="display: none;">
                    <div class="typing-indicator" id="typing-indicator">
                        <span id="typing-user">User</span> is typing
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    <button class="emoji-btn" title="Add photo">
                        <i class="far fa-image"></i>
                    </button>
                    <div class="message-input-wrapper">
                        <input type="text" id="message-input-field" placeholder="Message..." />
                        <button class="emoji-btn" id="emoji-btn" title="Add emoji">
                            <i class="far fa-smile"></i>
                        </button>
                    </div>
                    <button id="send-message-btn" title="Send message">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Chat Modal -->
    <div class="video-chat-modal" id="video-chat-modal">
        <div class="video-chat-container">
            <div class="video-chat-header">
                <h3 class="video-chat-title">Video Call with <span id="video-call-user"></span></h3>
                <button class="video-chat-close" id="close-video-chat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="video-streams">
                <div class="video-stream remote">
                    <video id="remote-video" autoplay></video>
                </div>
                <div class="video-stream local">
                    <video id="local-video" autoplay muted></video>
                </div>
            </div>
            <div class="video-controls">
                <button class="video-control-btn mute" id="toggle-audio">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="video-control-btn video" id="toggle-video">
                    <i class="fas fa-video"></i>
                </button>
                <button class="video-control-btn end-call" id="end-call">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Picture Upload Modal -->
    <div class="modal" id="profile-pic-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Profile Picture</h3>
                <button class="close-modal" id="close-profile-pic-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-container">
                    <div class="preview-container">
                        <img id="profile-pic-preview" src="#" alt="Preview" style="display: none; max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        <div id="profile-pic-placeholder" class="profile-pic-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="upload-actions">
                        <label for="profile-pic-input" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Select Image
                        </label>
                        <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                        <button id="remove-profile-pic" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-profile-pic" class="btn btn-primary">Save</button>
                <button id="cancel-profile-pic" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>ConnectPro</h3>
                    <p>The professional networking platform designed to help you connect, collaborate, and grow.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Press</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Community Guidelines</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="mailto:info@connectpro.com">info@connectpro.com</a></li>
                        <li><a href="tel:+1234567890">+1 (234) 567-890</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 ConnectPro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userData = localStorage.getItem('user');

            if (!userData) {
                // User is not logged in, redirect to signin page
                window.location.href = 'signin.html';
                return;
            }

            // Parse user data
            const user = JSON.parse(userData);

            // Set user avatar
            const userAvatar = document.getElementById('user-avatar');
            userAvatar.innerHTML = getInitials(user.firstName, user.lastName, user.username);

            // Handle logout
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('user');
                showNotification(true, 'You have been logged out successfully.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            });

            // DOM elements
            const conversationsList = document.getElementById('conversations-list');
            const chatArea = document.getElementById('chat-area');
            const emptyChatState = document.getElementById('empty-chat-state');
            const chatInterface = document.getElementById('chat-interface');
            const chatUserAvatar = document.getElementById('chat-user-avatar');
            const chatUserName = document.getElementById('chat-user-name');
            const chatUserStatus = document.getElementById('chat-user-status');
            const messagesList = document.getElementById('messages-list');
            const messageInputField = document.getElementById('message-input-field');
            const sendMessageBtn = document.getElementById('send-message-btn');
            const videoCallBtn = document.getElementById('video-call-btn');
            const videoChatModal = document.getElementById('video-chat-modal');
            const closeVideoChat = document.getElementById('close-video-chat');
            const videoCallUser = document.getElementById('video-call-user');
            const toggleAudio = document.getElementById('toggle-audio');
            const toggleVideo = document.getElementById('toggle-video');
            const endCall = document.getElementById('end-call');
            const localVideo = document.getElementById('local-video');
            const remoteVideo = document.getElementById('remote-video');

            // Current conversation state
            let currentConversation = null;
            let localStream = null;
            let peer = null;
            let socket = null; // WebSocket connection

            // Request notification permission
            if (Notification && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }

            // Initialize WebSocket connection
            initWebSocket();

            // Load conversations
            loadConversations();

            // Initialize profile picture functionality
            initProfilePicture();

            // Initialize notifications
            initNotifications();

            // Event listeners
            messageInputField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                } else {
                    // Send typing indicator
                    sendTypingIndicator(true);

                    // Clear typing indicator after a delay
                    clearTimeout(this.typingTimeout);
                    this.typingTimeout = setTimeout(() => {
                        sendTypingIndicator(false);
                    }, 3000);
                }
            });

            sendMessageBtn.addEventListener('click', sendMessage);

            // Emoji button functionality
            const emojiBtn = document.getElementById('emoji-btn');
            emojiBtn.addEventListener('click', function() {
                // Simple emoji picker - in a real app, you'd use a proper emoji picker library
                const emojis = ['', '', '', '', '', '', '', '', '', ''];

                // Create emoji picker element if it doesn't exist
                let emojiPicker = document.getElementById('emoji-picker');
                if (!emojiPicker) {
                    emojiPicker = document.createElement('div');
                    emojiPicker.id = 'emoji-picker';
                    emojiPicker.style.position = 'absolute';
                    emojiPicker.style.bottom = '70px';
                    emojiPicker.style.right = '70px';
                    emojiPicker.style.backgroundColor = 'white';
                    emojiPicker.style.borderRadius = '8px';
                    emojiPicker.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                    emojiPicker.style.padding = '10px';
                    emojiPicker.style.display = 'grid';
                    emojiPicker.style.gridTemplateColumns = 'repeat(5, 1fr)';
                    emojiPicker.style.gap = '5px';
                    emojiPicker.style.zIndex = '100';

                    // Add emojis to picker
                    emojis.forEach(emoji => {
                        const emojiBtn = document.createElement('button');
                        emojiBtn.textContent = emoji;
                        emojiBtn.style.fontSize = '20px';
                        emojiBtn.style.background = 'none';
                        emojiBtn.style.border = 'none';
                        emojiBtn.style.cursor = 'pointer';
                        emojiBtn.style.borderRadius = '4px';
                        emojiBtn.style.padding = '5px';
                        emojiBtn.style.transition = 'background-color 0.2s';

                        emojiBtn.addEventListener('mouseover', function() {
                            this.style.backgroundColor = '#f1f1f1';
                        });

                        emojiBtn.addEventListener('mouseout', function() {
                            this.style.backgroundColor = 'transparent';
                        });

                        emojiBtn.addEventListener('click', function() {
                            messageInputField.value += emoji;
                            messageInputField.focus();
                            emojiPicker.remove();
                        });

                        emojiPicker.appendChild(emojiBtn);
                    });

                    // Add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '';
                    closeBtn.style.position = 'absolute';
                    closeBtn.style.top = '5px';
                    closeBtn.style.right = '5px';
                    closeBtn.style.background = 'none';
                    closeBtn.style.border = 'none';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.style.fontSize = '12px';
                    closeBtn.style.color = '#666';

                    closeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        emojiPicker.remove();
                    });

                    emojiPicker.appendChild(closeBtn);

                    // Add to DOM
                    document.querySelector('.message-input').appendChild(emojiPicker);

                    // Close when clicking outside
                    document.addEventListener('click', function closeEmojiPicker(e) {
                        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                            emojiPicker.remove();
                            document.removeEventListener('click', closeEmojiPicker);
                        }
                    });
                } else {
                    emojiPicker.remove();
                }
            });

            videoCallBtn.addEventListener('click', function() {
                if (currentConversation) {
                    startVideoCall(currentConversation);
                }
            });

            closeVideoChat.addEventListener('click', endVideoCall);
            endCall.addEventListener('click', endVideoCall);

            toggleAudio.addEventListener('click', function() {
                if (localStream) {
                    const audioTracks = localStream.getAudioTracks();
                    if (audioTracks.length > 0) {
                        const enabled = !audioTracks[0].enabled;
                        audioTracks[0].enabled = enabled;
                        this.innerHTML = enabled ?
                            '<i class="fas fa-microphone"></i>' :
                            '<i class="fas fa-microphone-slash"></i>';
                        this.classList.toggle('active', !enabled);
                    }
                }
            });

            toggleVideo.addEventListener('click', function() {
                if (localStream) {
                    const videoTracks = localStream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        const enabled = !videoTracks[0].enabled;
                        videoTracks[0].enabled = enabled;
                        this.innerHTML = enabled ?
                            '<i class="fas fa-video"></i>' :
                            '<i class="fas fa-video-slash"></i>';
                        this.classList.toggle('active', !enabled);
                    }
                }
            });

            // Function to load conversations
            function loadConversations() {
                conversationsList.innerHTML = '<div class="loading">Loading conversations...</div>';

                // Fetch user's connections to show as conversations
                fetch(`/api/connections/${user.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.connections && data.connections.length > 0) {
                            // Convert connections to conversations format
                            const conversations = data.connections.map(connection => {
                                return {
                                    id: `conv_${connection.id}`, // Use a prefix to distinguish from actual conversation IDs
                                    user: {
                                        id: connection.id,
                                        firstName: connection.firstName,
                                        lastName: connection.lastName,
                                        username: connection.username,
                                        status: 'online' // Default status
                                    },
                                    lastMessage: {
                                        text: 'Click to start a conversation',
                                        time: 'Now',
                                        isRead: true
                                    }
                                };
                            });

                            renderConversations(conversations);

                            // Check if there's a conversation ID in the URL (for direct linking)
                            const urlParams = new URLSearchParams(window.location.search);
                            const conversationId = urlParams.get('conversation');
                            if (conversationId) {
                                const conversationItem = document.querySelector(`.conversation-item[data-user-id="${conversationId}"]`);
                                if (conversationItem) {
                                    conversationItem.click();
                                }
                            } else if (conversations.length > 0) {
                                // Auto-select first conversation
                                document.querySelector('.conversation-item').click();
                            }
                        } else {
                            // No connections found
                            conversationsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-user-friends"></i>
                                    <h3>No Connections Yet</h3>
                                    <p>Connect with professionals to start messaging.</p>
                                    <a href="network.html" class="btn btn-primary">Find Connections</a>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching connections:', error);
                        conversationsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-circle"></i>
                                <h3>Error Loading Conversations</h3>
                                <p>There was an error connecting to the server. Please try again later.</p>
                                <button class="btn btn-primary" onclick="loadConversations()">Retry</button>
                            </div>
                        `;
                    });
            }

            // Function to render conversations
            function renderConversations(conversations) {
                if (!conversations || conversations.length === 0) {
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No Conversations Yet</h3>
                            <p>Connect with professionals to start messaging.</p>
                            <a href="network.html" class="btn btn-primary">Find Connections</a>
                        </div>
                    `;
                    return;
                }

                let html = '';
                conversations.forEach(conversation => {
                    const { user, lastMessage } = conversation;
                    const fullName = `${user.firstName} ${user.lastName}`;
                    const initials = getInitials(user.firstName, user.lastName);
                    const unreadClass = !lastMessage.isRead ? 'unread' : '';

                    // Try to get the user's profile picture from localStorage
                    const profilePicKey = `profilePicture_${user.id}`;
                    const profilePic = localStorage.getItem(profilePicKey);

                    html += `
                        <div class="conversation-item ${unreadClass}" data-conversation-id="${conversation.id}" data-user-id="${user.id}" data-user-name="${fullName}" data-user-status="${user.status}">
                            <div class="conversation-avatar">
                                ${profilePic ?
                                    `<img src="${profilePic}" alt="${fullName}" class="profile-pic">` :
                                    initials
                                }
                            </div>
                            <div class="conversation-info">
                                <div class="conversation-header">
                                    <h4 class="conversation-name">${fullName}</h4>
                                    <span class="conversation-time">${lastMessage.time}</span>
                                </div>
                                <p class="conversation-preview">${lastMessage.text}</p>
                            </div>
                            ${!lastMessage.isRead ? '<div class="unread-indicator"></div>' : ''}
                        </div>
                    `;
                });

                conversationsList.innerHTML = html;

                // Add event listeners to conversation items
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const conversationId = this.getAttribute('data-conversation-id');
                        const userId = this.getAttribute('data-user-id');
                        const userName = this.getAttribute('data-user-name');
                        const userStatus = this.getAttribute('data-user-status');

                        // Remove active class from all conversations
                        document.querySelectorAll('.conversation-item').forEach(conv => {
                            conv.classList.remove('active');
                        });

                        // Add active class to clicked conversation
                        this.classList.add('active');

                        // Remove unread indicator
                        const unreadIndicator = this.querySelector('.unread-indicator');
                        if (unreadIndicator) {
                            unreadIndicator.remove();
                        }

                        // Load conversation
                        loadConversation({
                            id: conversationId,
                            user: {
                                id: userId,
                                name: userName,
                                status: userStatus
                            }
                        });
                    });
                });

                // Auto-select first conversation if none is selected
                if (!currentConversation && conversations.length > 0) {
                    document.querySelector('.conversation-item').click();
                }
            }

            // Function to load a conversation
            function loadConversation(conversation) {
                currentConversation = conversation;

                // Show chat interface, hide empty state
                emptyChatState.style.display = 'none';
                chatInterface.style.display = 'flex';
                document.getElementById('message-input-area').style.display = 'flex';

                // Update chat header
                const fullName = `${conversation.user.firstName} ${conversation.user.lastName}`.trim() || conversation.user.username;

                // Try to get the user's profile picture from localStorage
                const profilePicKey = `profilePicture_${conversation.user.id}`;
                const profilePic = localStorage.getItem(profilePicKey);

                if (profilePic) {
                    chatUserAvatar.innerHTML = `<img src="${profilePic}" alt="${fullName}" class="profile-pic">`;
                } else {
                    chatUserAvatar.innerHTML = getInitials(conversation.user.firstName, conversation.user.lastName, conversation.user.username);
                }

                chatUserName.textContent = fullName;
                chatUserStatus.textContent = conversation.user.status === 'online' ? 'Online' : 'Offline';

                // Clear previous messages
                messagesList.innerHTML = '<div class="loading">Loading messages...</div>';

                // Get the actual conversation ID (remove the 'conv_' prefix if it exists)
                let conversationId = conversation.id;
                if (conversationId.startsWith('conv_')) {
                    conversationId = conversationId.substring(5);
                }

                // Fetch messages from the server
                fetch(`/api/messages/${conversationId}/${user.id}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched messages:', data);

                        if (data.success) {
                            // Format messages for rendering
                            const messages = data.messages.map(msg => ({
                                id: msg.id,
                                sender: msg.sender,
                                text: msg.text,
                                time: msg.time
                            }));

                            // If no messages, show a welcome message
                            if (messages.length === 0) {
                                const welcomeMessage = {
                                    id: 'welcome',
                                    sender: 'system',
                                    text: `This is the beginning of your conversation with ${fullName}. Say hello!`,
                                    time: formatTime(new Date())
                                };
                                messages.unshift(welcomeMessage);
                            }

                            renderMessages(messages);
                        } else {
                            // If error or no messages, show welcome message
                            const welcomeMessage = {
                                id: 'welcome',
                                sender: 'system',
                                text: `This is the beginning of your conversation with ${fullName}. Say hello!`,
                                time: formatTime(new Date())
                            };
                            renderMessages([welcomeMessage]);

                            if (data.message) {
                                console.error('Error fetching messages:', data.message);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching messages:', error);

                        // Show welcome message on error
                        const welcomeMessage = {
                            id: 'welcome',
                            sender: 'system',
                            text: `This is the beginning of your conversation with ${fullName}. Say hello!`,
                            time: formatTime(new Date())
                        };
                        renderMessages([welcomeMessage]);
                    });

                // Focus on message input
                messageInputField.focus();
            }

            // Function to render messages
            function renderMessages(messages) {
                if (!messages || messages.length === 0) {
                    messagesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment"></i>
                            <h3>No Messages Yet</h3>
                            <p>Start the conversation by sending a message.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                let currentDate = null;

                messages.forEach(message => {
                    // Get message timestamp
                    let messageTimestamp = message.time;
                    if (typeof messageTimestamp === 'string' && messageTimestamp.includes('T')) {
                        messageTimestamp = new Date(messageTimestamp);
                    } else if (!(messageTimestamp instanceof Date)) {
                        // If not a date object or ISO string, try to create a date
                        const tempDate = new Date(messageTimestamp);
                        if (!isNaN(tempDate.getTime())) {
                            messageTimestamp = tempDate;
                        } else {
                            // If all else fails, use current date
                            messageTimestamp = new Date();
                        }
                    }

                    // Add date separator if needed
                    const formattedDate = messageTimestamp instanceof Date && !isNaN(messageTimestamp)
                        ? messageTimestamp.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })
                        : 'Today';

                    if (currentDate !== formattedDate) {
                        html += `
                            <div class="date-separator">
                                <span class="date-separator-text">${formattedDate}</span>
                            </div>
                        `;
                        currentDate = formattedDate;
                    }

                    if (message.sender === 'system') {
                        // System message (like welcome message)
                        html += `
                            <div class="message system" data-message-id="${message.id}">
                                <div class="message-content">${message.text}</div>
                                <div class="message-time">${formatTime(messageTimestamp)}</div>
                            </div>
                        `;
                    } else {
                        // Check if sender is a string (ID) or an object
                        let senderId = message.sender;
                        if (typeof message.sender === 'object' && message.sender !== null) {
                            senderId = message.sender.id || message.sender._id;
                        }

                        const isSent = senderId === user.id;
                        const messageClass = isSent ? 'sent' : 'received';

                        // Check if content is in text or content field
                        const messageContent = message.text || message.content || '';

                        // Format time
                        const messageTime = formatTime(messageTimestamp);

                        // Add read status for sent messages
                        const statusIcon = isSent ?
                            `<i class="fas fa-check message-status" title="Delivered"></i>` : '';

                        html += `
                            <div class="message ${messageClass}" data-message-id="${message.id}">
                                <div class="message-content">${messageContent}</div>
                                <div class="message-time">
                                    ${messageTime}
                                    ${statusIcon}
                                </div>
                            </div>
                        `;
                    }
                });

                messagesList.innerHTML = html;

                // Scroll to bottom
                messagesList.scrollTop = messagesList.scrollHeight;
            }

            // Initialize WebSocket connection
            function initWebSocket() {
                // Close existing connection if any
                if (socket) {
                    socket.close();
                }

                // Create new WebSocket connection with user ID
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/?userId=${user.id}`;

                console.log('Connecting to WebSocket at:', wsUrl);
                socket = new WebSocket(wsUrl);

                // Connection opened
                socket.onopen = function(event) {
                    console.log('WebSocket connection established');
                    showNotification(true, 'Connected to messaging service');
                };

                // Listen for messages
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('Message received:', data);

                    // Handle different message types
                    switch (data.type) {
                        case 'connection_established':
                            console.log('Connection confirmed with server');
                            break;

                        case 'new_message':
                            handleIncomingMessage(data.message);
                            break;

                        case 'message_sent':
                            console.log('Message sent confirmation:', data);
                            break;

                        case 'typing_indicator':
                            handleTypingIndicator(data);
                            break;

                        case 'messages_read':
                            handleMessagesRead(data);
                            break;

                        case 'error':
                            console.error('Error from server:', data.message);
                            showNotification(false, data.message);
                            break;

                        default:
                            console.log('Unknown message type:', data.type);
                    }
                };

                // Connection closed
                socket.onclose = function(event) {
                    console.log('WebSocket connection closed');

                    // Try to reconnect after a delay if not intentionally closed
                    if (event.code !== 1000) {
                        setTimeout(() => {
                            console.log('Attempting to reconnect...');
                            initWebSocket();
                        }, 3000);
                    }
                };

                // Connection error
                socket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    showNotification(false, 'Connection error. Please try again later.');
                };
            }

            // Handle incoming messages
            function handleIncomingMessage(message) {
                console.log('Received message:', message);

                // If we don't have a current conversation or it doesn't match the message,
                // we need to find or create the conversation item
                if (!currentConversation ||
                    (currentConversation.id !== message.conversationId &&
                     currentConversation.user.id !== message.sender.id)) {

                    // Check if we already have this conversation in the list
                    let conversationItem = document.querySelector(`.conversation-item[data-conversation-id="${message.conversationId}"]`);

                    if (!conversationItem) {
                        // We need to create a new conversation item or reload conversations
                        console.log('New conversation detected, reloading conversations');
                        loadConversations();

                        // Show notification
                        showNotification(true, `New message from ${message.sender.name}`);

                        // Show browser notification
                        if (Notification.permission === 'granted') {
                            new Notification('New Message', {
                                body: `${message.sender.name}: ${message.content}`,
                                icon: '/favicon.ico'
                            });
                        }

                        return;
                    }
                }

                // Check if the message is for the current conversation
                if (currentConversation &&
                    (message.conversationId === currentConversation.id ||
                     message.sender.id === currentConversation.user.id)) {

                    console.log('Message is for current conversation, adding to UI');

                    // Add message to UI
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message received';
                    messageElement.setAttribute('data-message-id', message.id);
                    messageElement.innerHTML = `
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${formatTime(new Date(message.timestamp))}</div>
                    `;
                    messagesList.appendChild(messageElement);

                    // Scroll to bottom
                    messagesList.scrollTop = messagesList.scrollHeight;

                    // Send read receipt
                    sendReadReceipt(message.conversationId);
                }

                // Update conversation preview regardless of current view
                const conversationId = message.conversationId ||
                                      (currentConversation ? currentConversation.id : null);

                if (conversationId) {
                    console.log('Updating conversation preview for:', conversationId);
                    updateConversationPreview(conversationId, {
                        sender: message.sender.id,
                        text: message.content,
                        time: formatTime(new Date(message.timestamp))
                    });
                }

                // Play notification sound if not in current conversation
                if (!currentConversation ||
                    (message.conversationId !== currentConversation.id &&
                     message.sender.id !== currentConversation.user.id)) {

                    console.log('Message is not for current conversation, showing notification');

                    // Show notification
                    showNotification(true, `New message from ${message.sender.name}`);

                    // Show browser notification
                    if (Notification.permission === 'granted') {
                        new Notification('New Message', {
                            body: `${message.sender.name}: ${message.content}`,
                            icon: '/favicon.ico'
                        });
                    }
                }
            }

            // Handle typing indicator
            function handleTypingIndicator(data) {
                if (currentConversation && data.userId === currentConversation.user.id) {
                    const typingIndicator = document.getElementById('typing-indicator');
                    const typingUser = document.getElementById('typing-user');

                    if (data.isTyping) {
                        // Set user name in typing indicator
                        typingUser.textContent = currentConversation.user.name || 'User';

                        // Show typing indicator
                        typingIndicator.classList.add('active');

                        // Update status in header
                        const statusElement = document.getElementById('chat-user-status');
                        statusElement.textContent = 'Typing...';
                    } else {
                        // Hide typing indicator
                        typingIndicator.classList.remove('active');

                        // Reset status
                        const statusElement = document.getElementById('chat-user-status');
                        statusElement.textContent = 'Online';
                    }
                }
            }

            // Handle messages read
            function handleMessagesRead(data) {
                if (currentConversation && data.conversationId === currentConversation.id) {
                    // Update read status in UI - change single check to double check
                    console.log('Messages read by recipient');

                    // Find all sent messages and update their status icons
                    const sentMessages = document.querySelectorAll('.message.sent');
                    sentMessages.forEach(message => {
                        const statusIcon = message.querySelector('.message-status');
                        if (statusIcon) {
                            statusIcon.className = 'fas fa-check-double message-status';
                            statusIcon.title = 'Read';
                            statusIcon.style.color = '#4CAF50'; // Green color for read messages
                        } else {
                            // If no status icon exists, add one
                            const timeElement = message.querySelector('.message-time');
                            if (timeElement) {
                                const icon = document.createElement('i');
                                icon.className = 'fas fa-check-double message-status';
                                icon.title = 'Read';
                                icon.style.color = '#4CAF50';
                                timeElement.appendChild(icon);
                            }
                        }
                    });
                }
            }

            // Send typing indicator
            function sendTypingIndicator(isTyping) {
                if (!socket || socket.readyState !== WebSocket.OPEN || !currentConversation) return;

                socket.send(JSON.stringify({
                    type: 'typing',
                    recipientId: currentConversation.user.id,
                    isTyping: isTyping
                }));
            }

            // Send read receipt
            function sendReadReceipt(conversationId) {
                if (!socket || socket.readyState !== WebSocket.OPEN) return;

                socket.send(JSON.stringify({
                    type: 'read_receipt',
                    conversationId: conversationId
                }));
            }

            // Function to send a message
            function sendMessage() {
                const messageText = messageInputField.value.trim();

                if (!messageText || !currentConversation) {
                    return;
                }

                // Clear input field
                messageInputField.value = '';

                // Stop typing indicator if WebSocket is connected
                if (socket && socket.readyState === WebSocket.OPEN) {
                    sendTypingIndicator(false);
                }

                // Create temporary message ID
                const tempId = 'temp_' + Date.now().toString();
                const currentTime = new Date();

                // Add message to UI immediately
                const messageElement = document.createElement('div');
                messageElement.className = 'message sent';
                messageElement.setAttribute('data-message-id', tempId);
                messageElement.innerHTML = `
                    <div class="message-content">${messageText}</div>
                    <div class="message-time">
                        ${formatTime(currentTime)}
                        <i class="fas fa-clock message-status" title="Sending..."></i>
                    </div>
                `;
                messagesList.appendChild(messageElement);

                // Scroll to bottom
                messagesList.scrollTop = messagesList.scrollHeight;

                // Get the actual conversation ID (remove the 'conv_' prefix if it exists)
                let conversationId = currentConversation.id;
                if (conversationId.startsWith('conv_')) {
                    conversationId = conversationId.substring(5);
                }

                // Try to send via WebSocket first for real-time delivery
                let websocketSent = false;
                if (socket && socket.readyState === WebSocket.OPEN) {
                    try {
                        socket.send(JSON.stringify({
                            type: 'chat_message',
                            recipientId: currentConversation.user.id,
                            conversationId: conversationId,
                            content: messageText
                        }));
                        websocketSent = true;
                    } catch (error) {
                        console.error('Error sending message via WebSocket:', error);
                    }
                }

                // If WebSocket fails or is not connected, use the REST API as fallback
                if (!websocketSent) {
                    console.log('WebSocket unavailable, using REST API fallback');

                    // Send message via REST API
                    fetch('/api/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            senderId: user.id,
                            recipientId: currentConversation.user.id,
                            content: messageText,
                            conversationId: conversationId !== currentConversation.user.id ? conversationId : null
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Message sent via REST API:', data);

                        if (data.success) {
                            // Update the temporary message with the real ID
                            const tempMessage = document.querySelector(`[data-message-id="${tempId}"]`);
                            if (tempMessage) {
                                tempMessage.setAttribute('data-message-id', data.messageData.id);

                                // Update status icon to "delivered"
                                const statusIcon = tempMessage.querySelector('.message-status');
                                if (statusIcon) {
                                    statusIcon.className = 'fas fa-check message-status';
                                    statusIcon.title = 'Delivered';
                                }
                            }

                            showNotification(true, 'Message sent successfully');
                        } else {
                            showNotification(false, data.message || 'Failed to send message');

                            // Mark the message as failed
                            const tempMessage = document.querySelector(`[data-message-id="${tempId}"]`);
                            if (tempMessage) {
                                tempMessage.style.opacity = '0.6';
                                tempMessage.querySelector('.message-time').textContent += ' (Failed to send)';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message via REST API:', error);
                        showNotification(false, 'Network error. Please try again.');

                        // Mark the message as failed
                        const tempMessage = document.querySelector(`[data-message-id="${tempId}"]`);
                        if (tempMessage) {
                            tempMessage.style.opacity = '0.6';
                            tempMessage.querySelector('.message-time').textContent += ' (Failed to send)';
                        }
                    });
                }

                // Update conversation preview
                updateConversationPreview(currentConversation.id, {
                    sender: user.id,
                    text: messageText,
                    time: 'Just now'
                });
            }

            // Function to update conversation preview
            function updateConversationPreview(conversationId, message) {
                const conversationItem = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
                if (conversationItem) {
                    const previewElement = conversationItem.querySelector('.conversation-preview');
                    const timeElement = conversationItem.querySelector('.conversation-time');

                    previewElement.textContent = message.text;
                    timeElement.textContent = 'Just now';

                    // Move conversation to top
                    const parent = conversationItem.parentNode;
                    parent.insertBefore(conversationItem, parent.firstChild);
                }
            }

            // Function to start a video call
            function startVideoCall(conversation) {
                videoCallUser.textContent = conversation.user.name;
                videoChatModal.style.display = 'flex';

                // Request user media
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        localStream = stream;
                        localVideo.srcObject = stream;

                        // In a real app, this would initiate a WebRTC connection
                        // For demo purposes, we'll just show a notification
                        showNotification(true, `Calling ${conversation.user.name}...`);

                        // Simulate connection after a delay
                        setTimeout(() => {
                            // Simulate remote stream (in a real app this would come from the peer)
                            // For demo, we'll just use a copy of the local stream
                            remoteVideo.srcObject = stream;
                            showNotification(true, `Connected with ${conversation.user.name}`);
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Error accessing media devices:', error);
                        showNotification(false, 'Could not access camera or microphone');
                        endVideoCall();
                    });
            }

            // Function to end a video call
            function endVideoCall() {
                videoChatModal.style.display = 'none';

                // Stop all tracks
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }

                // Reset video elements
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;

                // Reset buttons
                toggleAudio.innerHTML = '<i class="fas fa-microphone"></i>';
                toggleAudio.classList.remove('active');
                toggleVideo.innerHTML = '<i class="fas fa-video"></i>';
                toggleVideo.classList.remove('active');
            }

            // Helper function to format time
            function formatTime(date) {
                if (!date) return 'Now';

                // If it's a string, try to convert to date
                if (typeof date === 'string') {
                    const tempDate = new Date(date);
                    if (!isNaN(tempDate.getTime())) {
                        date = tempDate;
                    } else {
                        return date; // Return original if can't convert
                    }
                }

                // If not a valid date object, return 'Now'
                if (!(date instanceof Date) || isNaN(date.getTime())) {
                    return 'Now';
                }

                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                const isYesterday = new Date(now.setDate(now.getDate() - 1)).toDateString() === date.toDateString();

                // Reset now after modifying it
                now.setDate(now.getDate() + 1);

                const hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12;
                const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                const timeString = `${formattedHours}:${formattedMinutes} ${ampm}`;

                if (isToday) {
                    return timeString;
                } else if (isYesterday) {
                    return `Yesterday, ${timeString}`;
                } else {
                    // If within the last week, show day name
                    const daysDiff = Math.round((now - date) / (1000 * 60 * 60 * 24));
                    if (daysDiff < 7) {
                        return date.toLocaleDateString('en-US', { weekday: 'short' }) + `, ${timeString}`;
                    } else {
                        // Otherwise show date
                        return date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        }) + `, ${timeString}`;
                    }
                }
            }

            // Helper function to get random reply (for demo)
            function getRandomReply() {
                const replies = [
                    "That sounds great!",
                    "I agree, let's move forward with that.",
                    "Interesting perspective. I hadn't thought of it that way.",
                    "Thanks for sharing that information.",
                    "I'll need some time to think about this.",
                    "Can we schedule a call to discuss this further?",
                    "I appreciate your input on this matter.",
                    "Let me check my schedule and get back to you.",
                    "I'm excited about this collaboration opportunity!",
                    "What timeline are you thinking for this project?"
                ];
                return replies[Math.floor(Math.random() * replies.length)];
            }

            // Function to get user initials
            function getInitials(firstName, lastName, username) {
                if (firstName && lastName) {
                    return `${firstName.charAt(0)}${lastName.charAt(0)}`;
                } else if (firstName) {
                    return firstName.charAt(0);
                } else if (username) {
                    return username.charAt(0).toUpperCase();
                } else {
                    return '<i class="fas fa-user"></i>';
                }
            }

            // Function to show notification
            function showNotification(isSuccess, message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = 'notification ' + (isSuccess ? 'success' : 'error');
                notification.classList.add('show');

                // Hide after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // Profile Picture Functionality
            function initNotifications() {
                const markAllReadBtn = document.querySelector('.mark-all-read');
                const notificationItems = document.querySelectorAll('.notification-item');
                const notificationBadge = document.querySelector('.notification-badge');

                // Update notification badge count
                function updateNotificationCount() {
                    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
                    if (unreadCount > 0) {
                        notificationBadge.textContent = unreadCount;
                        notificationBadge.style.display = 'flex';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }

                // Mark all notifications as read
                markAllReadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    notificationItems.forEach(item => {
                        item.classList.remove('unread');
                    });
                    updateNotificationCount();
                });

                // Mark individual notification as read when clicked
                notificationItems.forEach(item => {
                    item.addEventListener('click', function() {
                        this.classList.remove('unread');
                        updateNotificationCount();
                    });
                });

                // Initial count update
                updateNotificationCount();
            }

            function initProfilePicture() {
                const profilePicModal = document.getElementById('profile-pic-modal');
                const editProfilePicBtn = document.getElementById('edit-profile-pic');
                const closeProfilePicModal = document.getElementById('close-profile-pic-modal');
                const profilePicInput = document.getElementById('profile-pic-input');
                const profilePicPreview = document.getElementById('profile-pic-preview');
                const profilePicPlaceholder = document.getElementById('profile-pic-placeholder');
                const removeProfilePicBtn = document.getElementById('remove-profile-pic');
                const saveProfilePicBtn = document.getElementById('save-profile-pic');
                const cancelProfilePicBtn = document.getElementById('cancel-profile-pic');

                // Load existing profile picture if available
                loadProfilePicture();

                // Open modal when edit button is clicked
                editProfilePicBtn.addEventListener('click', function() {
                    profilePicModal.style.display = 'flex';
                });

                // Close modal when close button is clicked
                closeProfilePicModal.addEventListener('click', function() {
                    profilePicModal.style.display = 'none';
                });

                // Close modal when cancel button is clicked
                cancelProfilePicBtn.addEventListener('click', function() {
                    profilePicModal.style.display = 'none';
                    resetProfilePicPreview();
                });

                // Handle file selection
                profilePicInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];

                        // Check file type
                        if (!file.type.match('image.*')) {
                            showNotification(false, 'Please select an image file');
                            return;
                        }

                        // Check file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification(false, 'Image size should be less than 5MB');
                            return;
                        }

                        const reader = new FileReader();

                        reader.onload = function(e) {
                            profilePicPreview.src = e.target.result;
                            profilePicPreview.style.display = 'block';
                            profilePicPlaceholder.style.display = 'none';
                            removeProfilePicBtn.style.display = 'block';
                        };

                        reader.readAsDataURL(file);
                    }
                });

                // Handle remove button click
                removeProfilePicBtn.addEventListener('click', function() {
                    resetProfilePicPreview();
                });

                // Handle save button click
                saveProfilePicBtn.addEventListener('click', function() {
                    const profilePic = profilePicPreview.src;

                    if (profilePic && profilePic !== '#') {
                        // Save to localStorage
                        saveProfilePictureToStorage(profilePic);

                        // Update UI
                        updateProfilePictureUI(profilePic);

                        // Close modal
                        profilePicModal.style.display = 'none';

                        showNotification(true, 'Profile picture updated successfully');
                    } else if (profilePicPlaceholder.style.display !== 'none') {
                        // User wants to remove profile picture
                        localStorage.removeItem('profilePicture');

                        // Update UI to show initials
                        updateProfilePictureUI(null);

                        // Close modal
                        profilePicModal.style.display = 'none';

                        showNotification(true, 'Profile picture removed');
                    }
                });

                // Reset preview
                function resetProfilePicPreview() {
                    profilePicInput.value = '';
                    profilePicPreview.src = '#';
                    profilePicPreview.style.display = 'none';
                    profilePicPlaceholder.style.display = 'flex';
                    removeProfilePicBtn.style.display = 'none';
                }

                // Load profile picture from storage
                function loadProfilePicture() {
                    const profilePic = localStorage.getItem('profilePicture');

                    if (profilePic) {
                        updateProfilePictureUI(profilePic);
                    }
                }

                // Save profile picture to storage
                function saveProfilePictureToStorage(profilePic) {
                    localStorage.setItem('profilePicture', profilePic);
                }

                // Update UI with profile picture
                function updateProfilePictureUI(profilePic) {
                    // Update all user avatars in the UI
                    const userAvatars = [
                        document.getElementById('user-avatar'),
                        document.getElementById('chat-user-avatar')
                    ];

                    userAvatars.forEach(avatar => {
                        if (avatar) {
                            if (profilePic) {
                                // Create or update img element
                                let img = avatar.querySelector('img');
                                if (!img) {
                                    img = document.createElement('img');
                                    avatar.innerHTML = '';
                                    avatar.appendChild(img);
                                }
                                img.src = profilePic;
                                img.style.maxWidth = '100%';
                                img.style.maxHeight = '100%';
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                            } else {
                                // Show initials
                                const userData = JSON.parse(localStorage.getItem('user'));
                                avatar.innerHTML = getInitials(userData.firstName, userData.lastName, userData.username);
                            }
                        }
                    });

                    // Update preview in modal
                    if (profilePic) {
                        profilePicPreview.src = profilePic;
                        profilePicPreview.style.display = 'block';
                        profilePicPlaceholder.style.display = 'none';
                        removeProfilePicBtn.style.display = 'block';
                    } else {
                        resetProfilePicPreview();
                    }
                }
            }
        });
    </script>
</body>
</html>
